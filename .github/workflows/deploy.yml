on:
  release:
    types:
      - created  # Se activa cuando se crea una nueva release en el repositorio

jobs:
  # Este job se asegura de que las imágenes se construyan y se empujen antes del despliegue
  docker-build-push:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to GitHub Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          token: ${{ secrets.GITHUB_TOKEN }}  # GitHub Actions automatically provides this token

      - name: Build and push authservice
        uses: docker/build-push-action@v2
        with:
          context: ./users/authservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/authservice:latest

      - name: Build and push userservice
        uses: docker/build-push-action@v2
        with:
          context: ./users/userservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/userservice:latest

      - name: Build and push statsservice
        uses: docker/build-push-action@v2
        with:
          context: ./users/statsservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/statsservice:latest

      - name: Build and push llmservice
        uses: docker/build-push-action@v2
        with:
          context: ./llmservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/llmservice:latest

      - name: Build and push gatewayservice
        uses: docker/build-push-action@v2
        with:
          context: ./gatewayservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/gatewayservice:latest

      - name: Build and push webapp
        uses: docker/build-push-action@v2
        with:
          context: ./webapp
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/webapp:latest

      - name: Build and push wikiquestionservice
        uses: docker/build-push-action@v2
        with:
          context: ./wikiquestionservice
          push: true
          tags: ghcr.io/arquisoft/wichat_es3b/wikiquestionservice:latest

  # Este job realiza el despliegue de los contenedores después de que las imágenes hayan sido empujadas
  deploy:
    name: Deploy over SSH
    runs-on: ubuntu-latest
    needs: docker-build-push  # Asegura que el despliegue solo ocurra después de que las imágenes sean empujadas
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Deploy over SSH
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          user: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command: |
            wget https://raw.githubusercontent.com/Arquisoft/wichat_es3b/master/docker-compose.yml -O docker-compose.yml
            docker compose --profile prod down
            docker compose --profile prod up -d --pull always
